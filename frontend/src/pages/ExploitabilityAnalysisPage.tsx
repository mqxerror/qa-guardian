// ExploitabilityAnalysisPage - extracted from App.tsx
// Feature #775: Exploitability Analysis
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';

// Type definitions
interface ExploitabilityAnalysis {
  vulnerability_id: string;
  cve_id: string;
  dependency_name: string;
  dependency_version: string;
  epss_score: number;
  epss_percentile: number;
  reachability: {
    status: 'reachable' | 'potentially_reachable' | 'not_reachable' | 'unknown';
    confidence: number;
    call_paths: Array<{
      source_file: string;
      line_number: number;
      function_name: string;
      call_chain: string[];
    }>;
    affected_functions: string[];
    analysis_method: string;
  };
  known_exploits: {
    has_public_exploit: boolean;
    exploit_maturity: string;
    exploit_sources: Array<{ source: string; url?: string; date_published?: string }>;
    in_the_wild: boolean;
    ransomware_associated: boolean;
  };
  kev_status: {
    is_in_kev: boolean;
    date_added?: string;
    due_date?: string;
    notes?: string;
  };
  risk_assessment: {
    overall_risk: string;
    exploitability_score: number;
    impact_score: number;
    priority_score: number;
    recommended_action: string;
    remediation_effort: string;
  };
  analyzed_at: string;
}

export function ExploitabilityAnalysisPage() {
  const navigate = useNavigate();
  const token = localStorage.getItem('token');

  const [analyses, setAnalyses] = useState<ExploitabilityAnalysis[]>([]);
  const [selectedAnalysis, setSelectedAnalysis] = useState<ExploitabilityAnalysis | null>(null);
  const [summary, setSummary] = useState<any>(null);
  const [reachableOnly, setReachableOnly] = useState(false);
  const [minEpss, setMinEpss] = useState<string>('');
  const [showDetailModal, setShowDetailModal] = useState(false);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const selectedProject = 'proj-1';

  useEffect(() => {
    loadAnalyses();
  }, [token, selectedProject, reachableOnly, minEpss]);

  const loadAnalyses = async () => {
    const params = new URLSearchParams();
    if (reachableOnly) params.set('reachable_only', 'true');
    if (minEpss) params.set('min_epss', minEpss);

    try {
      const res = await fetch(`/api/v1/projects/${selectedProject}/exploitability-analysis?${params}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      setAnalyses(data.analyses || []);
      setSummary(data.summary);
    } catch (error) {
      console.error(error);
    }
  };

  const handleViewDetails = async (analysis: ExploitabilityAnalysis) => {
    try {
      const res = await fetch(`/api/v1/vulnerabilities/${analysis.vulnerability_id}/exploitability`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      setSelectedAnalysis(data);
      setShowDetailModal(true);
    } catch (error) {
      console.error(error);
    }
  };

  const handleRunReachabilityAnalysis = async (vulnerabilityId: string) => {
    setIsAnalyzing(true);
    try {
      await fetch(`/api/v1/vulnerabilities/${vulnerabilityId}/analyze-reachability`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ method: 'static' }),
      });
      // Reload to get updated analysis
      if (selectedAnalysis) {
        const res = await fetch(`/api/v1/vulnerabilities/${vulnerabilityId}/exploitability`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        setSelectedAnalysis(data);
      }
      loadAnalyses();
    } catch (error) {
      console.error(error);
    } finally {
      setIsAnalyzing(false);
    }
  };

  const riskColors: Record<string, string> = {
    critical: 'bg-red-100 text-red-800 border-red-300',
    high: 'bg-orange-100 text-orange-800 border-orange-300',
    medium: 'bg-yellow-100 text-yellow-800 border-yellow-300',
    low: 'bg-blue-100 text-blue-800 border-blue-300',
    informational: 'bg-gray-100 text-gray-600 border-gray-300',
  };

  const reachabilityColors: Record<string, string> = {
    reachable: 'bg-red-100 text-red-800',
    potentially_reachable: 'bg-orange-100 text-orange-800',
    not_reachable: 'bg-green-100 text-green-800',
    unknown: 'bg-gray-100 text-gray-600',
  };

  const reachabilityIcons: Record<string, string> = {
    reachable: '\u{1F3AF}',
    potentially_reachable: '\u26A0\uFE0F',
    not_reachable: '\u2705',
    unknown: '\u2753',
  };

  return (
    <div className="p-6 max-w-7xl mx-auto">
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <div>
          <button
            onClick={() => navigate('/security')}
            className="text-blue-600 hover:text-blue-800 mb-2 flex items-center"
          >
            &#8592; Back to Security
          </button>
          <h1 className="text-2xl font-bold">Exploitability Analysis</h1>
          <p className="text-gray-600">Analyze reachability and exploitation risk of vulnerabilities</p>
        </div>
      </div>

      {/* Summary Stats */}
      {summary && (
        <div className="grid grid-cols-4 gap-4 mb-6">
          <div className="bg-white rounded-lg border p-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-2xl font-bold">{summary.total_analyzed}</div>
                <div className="text-sm text-gray-600">Analyzed</div>
              </div>
              <span className="text-3xl">{'\u{1F4CA}'}</span>
            </div>
          </div>
          <div className="bg-white rounded-lg border p-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-2xl font-bold text-red-600">{summary.reachable}</div>
                <div className="text-sm text-gray-600">Reachable</div>
              </div>
              <span className="text-3xl">{'\u{1F3AF}'}</span>
            </div>
          </div>
          <div className="bg-white rounded-lg border p-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-2xl font-bold text-orange-600">{summary.with_known_exploits}</div>
                <div className="text-sm text-gray-600">Known Exploits</div>
              </div>
              <span className="text-3xl">{'\u{1F480}'}</span>
            </div>
          </div>
          <div className="bg-white rounded-lg border p-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-2xl font-bold">{summary.avg_epss_score}</div>
                <div className="text-sm text-gray-600">Avg EPSS Score</div>
              </div>
              <span className="text-3xl">{'\u{1F4C8}'}</span>
            </div>
          </div>
        </div>
      )}

      {/* Filters */}
      <div className="flex items-center space-x-4 mb-4 bg-white p-4 rounded-lg border">
        <label className="flex items-center text-sm">
          <input
            type="checkbox"
            checked={reachableOnly}
            onChange={(e) => setReachableOnly(e.target.checked)}
            className="mr-2"
          />
          Show only reachable
        </label>
        <div>
          <label className="text-sm text-gray-600 mr-2">Min EPSS:</label>
          <select
            value={minEpss}
            onChange={(e) => setMinEpss(e.target.value)}
            className="border rounded px-3 py-1.5"
          >
            <option value="">All</option>
            <option value="0.1">{'\u2265'} 0.1 (10%)</option>
            <option value="0.3">{'\u2265'} 0.3 (30%)</option>
            <option value="0.5">{'\u2265'} 0.5 (50%)</option>
          </select>
        </div>
        <div className="ml-auto text-sm text-gray-600">
          Showing {analyses.length} vulnerabilities
        </div>
      </div>

      {/* Vulnerabilities List */}
      <div className="space-y-3">
        {analyses.map((analysis) => (
          <div
            key={analysis.vulnerability_id}
            className="bg-white rounded-lg border p-4 hover:shadow-md transition-shadow cursor-pointer"
            onClick={() => handleViewDetails(analysis)}
          >
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <div className="flex items-center space-x-2 mb-2">
                  <span className={`text-xs px-2 py-0.5 rounded border ${riskColors[analysis.risk_assessment.overall_risk]}`}>
                    {analysis.risk_assessment.overall_risk.toUpperCase()} RISK
                  </span>
                  <span className={`text-xs px-2 py-0.5 rounded ${reachabilityColors[analysis.reachability.status]}`}>
                    {reachabilityIcons[analysis.reachability.status]} {analysis.reachability.status.replace('_', ' ')}
                  </span>
                  {analysis.known_exploits.has_public_exploit && (
                    <span className="text-xs px-2 py-0.5 rounded bg-purple-100 text-purple-800">
                      {'\u{1F480}'} Known Exploit
                    </span>
                  )}
                  {analysis.kev_status.is_in_kev && (
                    <span className="text-xs px-2 py-0.5 rounded bg-red-100 text-red-800">
                      {'\u{1F6A8}'} CISA KEV
                    </span>
                  )}
                </div>
                <div className="flex items-center space-x-3">
                  <span className="font-mono text-sm bg-gray-100 px-2 py-0.5 rounded">
                    {analysis.dependency_name}@{analysis.dependency_version}
                  </span>
                  <span className="text-xs text-gray-500">{analysis.cve_id}</span>
                </div>
              </div>
              <div className="text-right">
                <div className="text-sm">
                  <span className="text-gray-600">EPSS: </span>
                  <span className={`font-medium ${analysis.epss_score >= 0.5 ? 'text-red-600' : analysis.epss_score >= 0.1 ? 'text-orange-600' : 'text-green-600'}`}>
                    {(analysis.epss_score * 100).toFixed(1)}%
                  </span>
                </div>
                <div className="text-xs text-gray-500">
                  Priority: {analysis.risk_assessment.priority_score}/100
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* Detail Modal */}
      {showDetailModal && selectedAnalysis && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[85vh] overflow-y-auto">
            <div className="px-6 py-4 border-b flex justify-between items-center sticky top-0 bg-white">
              <h2 className="text-lg font-semibold">Exploitability Analysis Details</h2>
              <button onClick={() => setShowDetailModal(false)} className="text-gray-500 hover:text-gray-700">&#10005;</button>
            </div>
            <div className="p-6">
              {/* Header Info */}
              <div className="mb-6">
                <div className="flex items-center space-x-2 mb-2">
                  <span className={`text-xs px-2 py-0.5 rounded border ${riskColors[selectedAnalysis.risk_assessment.overall_risk]}`}>
                    {selectedAnalysis.risk_assessment.overall_risk.toUpperCase()} RISK
                  </span>
                  <span className="text-xs text-gray-500">{selectedAnalysis.cve_id}</span>
                </div>
                <h3 className="text-xl font-mono">{selectedAnalysis.dependency_name}@{selectedAnalysis.dependency_version}</h3>
              </div>

              {/* Grid layout for sections */}
              <div className="grid grid-cols-2 gap-6">
                {/* EPSS Score Section */}
                <div className="border rounded-lg p-4">
                  <h4 className="font-medium mb-3 flex items-center">
                    <span className="mr-2">{'\u{1F4C8}'}</span> EPSS Score
                  </h4>
                  <div className="flex items-center space-x-4">
                    <div className="text-4xl font-bold" style={{ color: selectedAnalysis.epss_score >= 0.5 ? '#dc2626' : selectedAnalysis.epss_score >= 0.1 ? '#ea580c' : '#16a34a' }}>
                      {(selectedAnalysis.epss_score * 100).toFixed(1)}%
                    </div>
                    <div>
                      <div className="text-sm text-gray-600">Probability of exploitation</div>
                      <div className="text-sm text-gray-600">in next 30 days</div>
                      <div className="text-xs text-gray-500 mt-1">
                        Percentile: {selectedAnalysis.epss_percentile}%
                      </div>
                    </div>
                  </div>
                </div>

                {/* Reachability Section */}
                <div className="border rounded-lg p-4">
                  <h4 className="font-medium mb-3 flex items-center">
                    <span className="mr-2">{'\u{1F3AF}'}</span> Reachability Assessment
                  </h4>
                  <div className="flex items-center space-x-3 mb-2">
                    <span className={`px-3 py-1 rounded ${reachabilityColors[selectedAnalysis.reachability.status]}`}>
                      {reachabilityIcons[selectedAnalysis.reachability.status]} {selectedAnalysis.reachability.status.replace('_', ' ')}
                    </span>
                    <span className="text-sm text-gray-600">
                      Confidence: {selectedAnalysis.reachability.confidence}%
                    </span>
                  </div>
                  <div className="text-xs text-gray-500">
                    Method: {selectedAnalysis.reachability.analysis_method}
                  </div>
                  <button
                    onClick={() => handleRunReachabilityAnalysis(selectedAnalysis.vulnerability_id)}
                    disabled={isAnalyzing}
                    className="mt-2 text-xs px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 disabled:opacity-50"
                  >
                    {isAnalyzing ? 'Analyzing...' : 'Re-analyze'}
                  </button>
                </div>

                {/* Known Exploits Section */}
                <div className="border rounded-lg p-4">
                  <h4 className="font-medium mb-3 flex items-center">
                    <span className="mr-2">{'\u{1F480}'}</span> Known Exploits
                  </h4>
                  {selectedAnalysis.known_exploits.has_public_exploit ? (
                    <div>
                      <div className="flex items-center space-x-2 mb-2">
                        <span className="px-2 py-0.5 bg-red-100 text-red-800 rounded text-sm">
                          Public Exploit Exists
                        </span>
                        <span className="px-2 py-0.5 bg-orange-100 text-orange-800 rounded text-xs">
                          {selectedAnalysis.known_exploits.exploit_maturity}
                        </span>
                      </div>
                      {selectedAnalysis.known_exploits.in_the_wild && (
                        <div className="text-sm text-red-600 mb-1">{'\u26A0\uFE0F'} Actively exploited in the wild</div>
                      )}
                      {selectedAnalysis.known_exploits.ransomware_associated && (
                        <div className="text-sm text-red-600 mb-1">{'\u{1F480}'} Associated with ransomware</div>
                      )}
                      <div className="mt-2 space-y-1">
                        {selectedAnalysis.known_exploits.exploit_sources.map((src, idx) => (
                          <div key={idx} className="text-xs text-gray-600">
                            {'\u2022'} {src.source} {src.date_published && `(${src.date_published})`}
                          </div>
                        ))}
                      </div>
                    </div>
                  ) : (
                    <div className="text-green-600">{'\u2705'} No known public exploits</div>
                  )}
                </div>

                {/* CISA KEV Section */}
                <div className="border rounded-lg p-4">
                  <h4 className="font-medium mb-3 flex items-center">
                    <span className="mr-2">{'\u{1F6A8}'}</span> CISA KEV Status
                  </h4>
                  {selectedAnalysis.kev_status.is_in_kev ? (
                    <div>
                      <div className="px-2 py-0.5 bg-red-100 text-red-800 rounded text-sm inline-block mb-2">
                        {'\u26A0\uFE0F'} In CISA KEV Catalog
                      </div>
                      {selectedAnalysis.kev_status.date_added && (
                        <div className="text-sm text-gray-600">Added: {selectedAnalysis.kev_status.date_added}</div>
                      )}
                      {selectedAnalysis.kev_status.due_date && (
                        <div className="text-sm text-red-600">Remediation due: {selectedAnalysis.kev_status.due_date}</div>
                      )}
                      {selectedAnalysis.kev_status.notes && (
                        <div className="text-xs text-gray-500 mt-1">{selectedAnalysis.kev_status.notes}</div>
                      )}
                    </div>
                  ) : (
                    <div className="text-green-600">{'\u2705'} Not in CISA KEV catalog</div>
                  )}
                </div>
              </div>

              {/* Call Paths Section */}
              {selectedAnalysis.reachability.call_paths.length > 0 && (
                <div className="mt-6 border rounded-lg p-4">
                  <h4 className="font-medium mb-3">{'\u{1F4CD}'} Call Paths to Vulnerable Code</h4>
                  <div className="space-y-3">
                    {selectedAnalysis.reachability.call_paths.map((path, idx) => (
                      <div key={idx} className="bg-gray-50 rounded p-3">
                        <div className="font-mono text-sm">
                          {path.source_file}:{path.line_number}
                        </div>
                        <div className="text-sm text-gray-600">
                          Function: <span className="font-mono">{path.function_name}</span>
                        </div>
                        <div className="mt-1 text-xs text-gray-500 font-mono">
                          {path.call_chain.join(' \u2192 ')}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Risk Assessment Section */}
              <div className="mt-6 border rounded-lg p-4">
                <h4 className="font-medium mb-3">{'\u{1F4CB}'} Risk Assessment</h4>
                <div className="grid grid-cols-3 gap-4 mb-4">
                  <div className="text-center">
                    <div className="text-2xl font-bold">{selectedAnalysis.risk_assessment.exploitability_score}</div>
                    <div className="text-xs text-gray-600">Exploitability</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold">{selectedAnalysis.risk_assessment.impact_score}</div>
                    <div className="text-xs text-gray-600">Impact</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold">{selectedAnalysis.risk_assessment.priority_score}</div>
                    <div className="text-xs text-gray-600">Priority Score</div>
                  </div>
                </div>
                <div className="bg-blue-50 rounded p-3">
                  <div className="text-sm font-medium text-blue-800 mb-1">Recommended Action:</div>
                  <div className="text-sm text-blue-700">{selectedAnalysis.risk_assessment.recommended_action}</div>
                </div>
                <div className="mt-2 text-sm text-gray-600">
                  Remediation effort: <span className="font-medium">{selectedAnalysis.risk_assessment.remediation_effort}</span>
                </div>
              </div>

              <div className="mt-4 text-xs text-gray-500">
                Analyzed at: {new Date(selectedAnalysis.analyzed_at).toLocaleString()}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
